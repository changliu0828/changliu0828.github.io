<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>libco源码笔记(3)自动切换 | Chang Liu&#39;s Blog</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <script src="https://kit.fontawesome.com/a0e5d04d0b.js" crossorigin="anonymous"></script>


  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">主页</a></li>
      
      <li><a href="/categories/">分类</a></li>
      
      <li><a href="/tags/">标签</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h2><span class="title">libco源码笔记(3)自动切换</span></h2>

<h3 class="date">2020/09/23</h3>
</div>


<aside class="toc">
<nav id="TableOfContents">
  <ul>
    <li><a href="#自动切换的背景">自动切换的背景</a></li>
    <li><a href="#超时管理">超时管理</a></li>
    <li><a href="#事件循环">事件循环</a></li>
    <li><a href="#hook后的poll">hook后的<code>poll</code></a></li>
    <li><a href="#最后">最后</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</aside>



<main>
<p>在之前的文章<a href="http://www.changliu.me/post/libco-manual/">libco源码笔记(2)显示切换</a>中，我们介绍了libco提供的显示协程切换接口，并讨论了协程池的使用。本文讨论libco提供的自动切换相关函数接口。建议配合我自己的<a href="https://github.com/changliu0828/libco">注释版本</a>阅读本文。</p>
<h1 id="自动切换的背景">自动切换的背景</h1>
<p>李方源的libco分享$^{[2]}$中讲到，使用libco之前，微信的大多的网络通信使用同步IO接口。为了快速改造现有业务代码，libco以hook系统调用的形式，提供了协程基础上的<code>poll</code>，<code>read</code>，<code>write</code>等原语。利用协程的特性，原来阻塞的系统调用可以达到非阻塞的效果。</p>
<h1 id="超时管理">超时管理</h1>
<p>libco为了对统一网络IO，条件变量需要超时管理的事件，实现了基于时间轮(timing wheel)的超时管理器。在介绍其对系统调用的hook前，容我们先铺垫一些关于这个超时管理器的实现。</p>
<p>如下图1所示，时间轮为图中深红色的轮状数组，数组的每一个单元我们称为一个槽(slot)。单个slot里存储一定时间内注册的事件列表（图中黄色链表）。在libco中，单个slot的精度为1毫秒，整个时间轮由60000个slot组成，对应的整个时间轮覆盖60秒的时间。libco中关于时间轮的接口函数主要是下面两个。</p>
<p><code>AddTimeout</code>通过计算当前时间<code>allNow</code>与时间轮起始时间<code>ullStart</code>的差，插入对应slot。特别注意的是当超时事件大于轮长60秒时，libco将这种事件插入到“最后一个&quot;slot。</p>
<p><code>TakeAllTimeout</code>通过计算当前时间<code>allNow</code>与时间轮起始时间<code>ullStart</code>的差，得出对应slot，遍历从起始索引<code>ullStartIdx</code>所指slot到其的所有slot中的超时项并移动到结果链表<code>apResult</code>中。</p>
<p>至此，我们看到通过时间轮，libco得以高效的完成对超时事件的管理。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#aaa;font-style:italic">/* 在时间轮中插入新项
</span><span style="color:#aaa;font-style:italic"> * @param 
</span><span style="color:#aaa;font-style:italic"> * apTimeout :时间轮结构
</span><span style="color:#aaa;font-style:italic"> * apItem    :新的超时项
</span><span style="color:#aaa;font-style:italic"> * allNow    :当前事件(timestamp in ms)
</span><span style="color:#aaa;font-style:italic"> * @return   :0成功, else失败行数
</span><span style="color:#aaa;font-style:italic"> */</span>
<span style="color:#0aa">int</span> <span style="color:#0a0">AddTimeout</span>( stTimeout_t *apTimeout,stTimeoutItem_t *apItem ,<span style="color:#0aa">unsigned</span> <span style="color:#0aa">long</span> <span style="color:#0aa">long</span> allNow );
<span style="color:#aaa;font-style:italic">/* 在时间轮中取出所有超时项
</span><span style="color:#aaa;font-style:italic"> * @param 
</span><span style="color:#aaa;font-style:italic"> * apTimeout:时间轮结构
</span><span style="color:#aaa;font-style:italic"> * allNow   :当前时间(timestamp in ms)
</span><span style="color:#aaa;font-style:italic"> * apResult :超时事件结果链表
</span><span style="color:#aaa;font-style:italic"> */</span>
<span style="color:#00a">inline</span> <span style="color:#0aa">void</span> <span style="color:#0a0">TakeAllTimeout</span>( stTimeout_t *apTimeout,<span style="color:#0aa">unsigned</span> <span style="color:#0aa">long</span> <span style="color:#0aa">long</span> allNow,stTimeoutItemLink_t *apResult );
</code></pre></td></tr></table>
</div>
</div><figure>
    <img src="/image/libco-auto/timing-wheel.png"
         alt="图1. 超时管理" width="100%"/> <figcaption>
            <p>图1. 超时管理</p>
        </figcaption>
</figure>

<h1 id="事件循环">事件循环</h1>
<p>libco通过epoll管理IO事件，通过<code>co_eventloop</code>触发IO事件，并切换至对应协程执行。我们回顾之前提到过的表示协程运行环境的线程私有全局变量<code>stCoRoutineEnv_t</code>中，持有epoll的结构体句柄<code>pEpoll</code>。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">stCoRoutineEnv_t</span>
{
  stCoRoutine_t *pCallStack[ <span style="color:#099">128</span> ];   <span style="color:#aaa;font-style:italic">//所有协程的调用栈
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">int</span> iCallStackSize;                 <span style="color:#aaa;font-style:italic">//pCallStack栈顶索引
</span><span style="color:#aaa;font-style:italic"></span>  stCoEpoll_t *pEpoll;                <span style="color:#aaa;font-style:italic">//epoll封装
</span><span style="color:#aaa;font-style:italic"></span>
  <span style="color:#aaa;font-style:italic">//for copy stack log lastco and nextco
</span><span style="color:#aaa;font-style:italic"></span>  stCoRoutine_t* pending_co;           
  stCoRoutine_t* occupy_co;           <span style="color:#aaa;font-style:italic">//当前协程
</span><span style="color:#aaa;font-style:italic"></span>};
</code></pre></td></tr></table>
</div>
</div><p><code>stCoEpoll_t</code>的定义如下，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">stCoEpoll_t</span>
{
  <span style="color:#0aa">int</span> iEpollFd;                                   <span style="color:#aaa;font-style:italic">//EpollFd
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">static</span> <span style="color:#00a">const</span> <span style="color:#0aa">int</span> _EPOLL_SIZE = <span style="color:#099">1024</span> * <span style="color:#099">10</span>;       <span style="color:#aaa;font-style:italic">//epoll_wait单次最大返回事件数量
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">stTimeout_t</span> *pTimeout;                   <span style="color:#aaa;font-style:italic">//时间轮, 超时管理
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">stTimeoutItemLink_t</span> *pstTimeoutList;     <span style="color:#aaa;font-style:italic">//已超时项链表
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">stTimeoutItemLink_t</span> *pstActiveList;      <span style="color:#aaa;font-style:italic">//已就绪项链表  
</span><span style="color:#aaa;font-style:italic"></span>  co_epoll_res *result;                           <span style="color:#aaa;font-style:italic">//epoll_wait结果
</span><span style="color:#aaa;font-style:italic"></span>};
</code></pre></td></tr></table>
</div>
</div><p>主事件循环代码如下，</p>
<p>$L11$阻塞在<code>epoll_wait</code>上，并设置超时时间为1毫秒。这里的<code>epoll_wait</code>并没有经过hook，为系统原生。</p>
<p>$L13-L29$取出所有的<code>result-&gt;events</code>的事件，执行预处理函数<code>pfnPrepare</code>，并加入<code>active</code>链表。</p>
<p>$L32-L42$取出所有超时时间并加入<code>active</code>链表。</p>
<p>$L59$对所有的<code>active</code>链表中事件调用处理函数<code>pfnProcess</code>。</p>
<p>$L66$检查是否需要退出事件循环。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#aaa;font-style:italic">/* 事件循环
</span><span style="color:#aaa;font-style:italic"> * @param 
</span><span style="color:#aaa;font-style:italic"> * ctx:epoll句柄
</span><span style="color:#aaa;font-style:italic"> * pfn:退出事件循环检查函数
</span><span style="color:#aaa;font-style:italic"> * arg:pfn参数
</span><span style="color:#aaa;font-style:italic"> */</span>
<span style="color:#0aa">void</span> <span style="color:#0a0">co_eventloop</span>( stCoEpoll_t *ctx,pfn_co_eventloop_t pfn,<span style="color:#0aa">void</span> *arg )
{
  <span style="color:#00a">if</span>( !ctx-&gt;result )
  {
    ctx-&gt;result =  co_epoll_res_alloc( stCoEpoll_t::_EPOLL_SIZE );
  }
  co_epoll_res *result = ctx-&gt;result; 

  <span style="color:#00a">for</span>(;;)
  {
    <span style="color:#0aa">int</span> ret = co_epoll_wait( ctx-&gt;iEpollFd,result,stCoEpoll_t::_EPOLL_SIZE, <span style="color:#099">1</span> );

    stTimeoutItemLink_t *active = (ctx-&gt;pstActiveList);
    stTimeoutItemLink_t *timeout = (ctx-&gt;pstTimeoutList);

    memset( timeout,<span style="color:#099">0</span>,<span style="color:#00a">sizeof</span>(stTimeoutItemLink_t) );  <span style="color:#aaa;font-style:italic">//清空超时队列
</span><span style="color:#aaa;font-style:italic"></span>
    <span style="color:#00a">for</span>(<span style="color:#0aa">int</span> i=<span style="color:#099">0</span>;i&lt;ret;i++)  <span style="color:#aaa;font-style:italic">//遍历有事件的fd
</span><span style="color:#aaa;font-style:italic"></span>    {
      stTimeoutItem_t *item = (stTimeoutItem_t*)result-&gt;events[i].data.ptr; <span style="color:#aaa;font-style:italic">//获取event里数据指向的stTimeoutItem_t
</span><span style="color:#aaa;font-style:italic"></span>      <span style="color:#00a">if</span>( item-&gt;pfnPrepare )  <span style="color:#aaa;font-style:italic">//如果有预处理函数，执行，由其加入就绪列表
</span><span style="color:#aaa;font-style:italic"></span>      {
        item-&gt;pfnPrepare( item,result-&gt;events[i],active );
      }
      <span style="color:#00a">else</span>  <span style="color:#aaa;font-style:italic">//手动加入就绪列表
</span><span style="color:#aaa;font-style:italic"></span>      {
        AddTail( active,item );
      }
    }

    <span style="color:#0aa">unsigned</span> <span style="color:#0aa">long</span> <span style="color:#0aa">long</span> now = GetTickMS();
    TakeAllTimeout( ctx-&gt;pTimeout,now,timeout );  <span style="color:#aaa;font-style:italic">//将超时项插入超时列表
</span><span style="color:#aaa;font-style:italic"></span>
    stTimeoutItem_t *lp = timeout-&gt;head;
    <span style="color:#00a">while</span>( lp )
    {
      <span style="color:#aaa;font-style:italic">//printf(&#34;raise timeout %p\n&#34;,lp);
</span><span style="color:#aaa;font-style:italic"></span>      lp-&gt;bTimeout = <span style="color:#0aa">true</span>;  <span style="color:#aaa;font-style:italic">//设置为超时
</span><span style="color:#aaa;font-style:italic"></span>      lp = lp-&gt;pNext;
    }

    Join&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( active,timeout );  <span style="color:#aaa;font-style:italic">//将超时列表合并入就绪列表
</span><span style="color:#aaa;font-style:italic"></span>
    lp = active-&gt;head;
    <span style="color:#00a">while</span>( lp )
    {

      PopHead&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( active );
            <span style="color:#00a">if</span> (lp-&gt;bTimeout &amp;&amp; now &lt; lp-&gt;ullExpireTime)  <span style="color:#aaa;font-style:italic">//还未达到超时时间但已经标记为超时的，加回时间轮 
</span><span style="color:#aaa;font-style:italic"></span>      {
        <span style="color:#0aa">int</span> ret = AddTimeout(ctx-&gt;pTimeout, lp, now);
        <span style="color:#00a">if</span> (!ret) 
        {
          lp-&gt;bTimeout = <span style="color:#0aa">false</span>;
          lp = active-&gt;head;
          <span style="color:#00a">continue</span>;
        }
      }
      <span style="color:#00a">if</span>( lp-&gt;pfnProcess )  <span style="color:#aaa;font-style:italic">//调用stTimeoutItem_t项的执行函数
</span><span style="color:#aaa;font-style:italic"></span>      {
        lp-&gt;pfnProcess( lp );
      }

      lp = active-&gt;head;
    }
    <span style="color:#00a">if</span>( pfn )  <span style="color:#aaa;font-style:italic">//用于用户控制跳出事件循环
</span><span style="color:#aaa;font-style:italic"></span>    {
      <span style="color:#00a">if</span>( -<span style="color:#099">1</span> == pfn( arg ) )
      {
        <span style="color:#00a">break</span>;
      }
    }
  }
}
</code></pre></td></tr></table>
</div>
</div><h1 id="hook后的poll">hook后的<code>poll</code></h1>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">pollfd</span> {
  <span style="color:#0aa">int</span>   fd;         <span style="color:#aaa;font-style:italic">/* file descriptor */</span>
  <span style="color:#0aa">short</span> events;     <span style="color:#aaa;font-style:italic">/* requested events */</span>
  <span style="color:#0aa">short</span> revents;    <span style="color:#aaa;font-style:italic">/* returned events */</span>
};
<span style="color:#0aa">int</span> <span style="color:#0a0">poll</span>(<span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">pollfd</span> *fds, nfds_t nfds, <span style="color:#0aa">int</span> timeout);
</code></pre></td></tr></table>
</div>
</div><p>原始的<code>poll</code>函数以<code>pollfd</code>数组的形式传入fd以及关注的事件<code>events</code>，并返回相应的时间于<code>revents</code>。此外<code>poll</code>支持毫秒级别的超时设置，当<code>timeout</code>设置为非0值时(负数为永久)，线程会阻塞于poll直到有对应事件发生或超时。</p>
<p>libco所hook后的poll可以在IO协程阻塞时让出上下文，切换至主协程。其中，大部分代码是处理传入<code>pollfd</code>数组中相同fd的事件合并和还原。代码中的核心部分为<code>co_poll_inner</code>，其代码如下，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#aaa;font-style:italic">/* poll内核
</span><span style="color:#aaa;font-style:italic"> * @param 
</span><span style="color:#aaa;font-style:italic"> * ctx:epoll句柄
</span><span style="color:#aaa;font-style:italic"> * fds:fd数组
</span><span style="color:#aaa;font-style:italic"> * nfds:fd数组长度
</span><span style="color:#aaa;font-style:italic"> * timeout:超时时间ms
</span><span style="color:#aaa;font-style:italic"> * pollfunc:默认poll 
</span><span style="color:#aaa;font-style:italic"> */</span>
<span style="color:#0aa">int</span> <span style="color:#0a0">co_poll_inner</span>( stCoEpoll_t *ctx,<span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">pollfd</span> fds[], nfds_t nfds, <span style="color:#0aa">int</span> timeout, poll_pfn_t pollfunc)
{
  <span style="color:#00a">if</span> (timeout == <span style="color:#099">0</span>) <span style="color:#aaa;font-style:italic">//poll: Specifying a timeout of zero causes poll() to return immediately, even if no file descriptors are ready.
</span><span style="color:#aaa;font-style:italic"></span>  {
    <span style="color:#00a">return</span> pollfunc(fds, nfds, timeout);  <span style="color:#aaa;font-style:italic">//调用系统原生poll(其实上层poll已经做过检查了，此处无需再做)
</span><span style="color:#aaa;font-style:italic"></span>  }
  <span style="color:#00a">if</span> (timeout &lt; <span style="color:#099">0</span>)  <span style="color:#aaa;font-style:italic">//poll: Specifying a negative value in timeout means an infinite timeout.
</span><span style="color:#aaa;font-style:italic"></span>  {
    timeout = INT_MAX;
  }
  <span style="color:#0aa">int</span> epfd = ctx-&gt;iEpollFd;
  stCoRoutine_t* self = co_self();

  <span style="color:#aaa;font-style:italic">//1.struct change
</span><span style="color:#aaa;font-style:italic"></span>  stPoll_t&amp; arg = *((stPoll_t*)malloc(<span style="color:#00a">sizeof</span>(stPoll_t))); <span style="color:#aaa;font-style:italic">//分配一个stPoll_t
</span><span style="color:#aaa;font-style:italic"></span>  memset( &amp;arg,<span style="color:#099">0</span>,<span style="color:#00a">sizeof</span>(arg) );

  arg.iEpollFd = epfd;  <span style="color:#aaa;font-style:italic">//此处stPoll_t与stCoEpoll_t进行关联
</span><span style="color:#aaa;font-style:italic"></span>  arg.fds = (pollfd*)calloc(nfds, <span style="color:#00a">sizeof</span>(pollfd));  <span style="color:#aaa;font-style:italic">//分配nfds个pollfd
</span><span style="color:#aaa;font-style:italic"></span>  arg.nfds = nfds;

  stPollItem_t arr[<span style="color:#099">2</span>];
  <span style="color:#00a">if</span>( nfds &lt; <span style="color:#00a">sizeof</span>(arr) / <span style="color:#00a">sizeof</span>(arr[<span style="color:#099">0</span>]) &amp;&amp; !self-&gt;cIsShareStack)  <span style="color:#aaa;font-style:italic">//nfds少于2且未使用共享栈的情况下
</span><span style="color:#aaa;font-style:italic"></span>  {
    arg.pPollItems = arr;
  } 
  <span style="color:#00a">else</span>
  {
    arg.pPollItems = (stPollItem_t*)malloc( nfds * <span style="color:#00a">sizeof</span>( stPollItem_t ) );
  }
  memset( arg.pPollItems,<span style="color:#099">0</span>,nfds * <span style="color:#00a">sizeof</span>(stPollItem_t) );

  arg.pfnProcess = OnPollProcessEvent;  <span style="color:#aaa;font-style:italic">//处理函数, 调用co_resume(arg.pArg), 唤醒参数arg.pArg所指协程
</span><span style="color:#aaa;font-style:italic"></span>  arg.pArg = GetCurrCo( co_get_curr_thread_env() ); <span style="color:#aaa;font-style:italic">//处理函数参数, 即当前协程
</span><span style="color:#aaa;font-style:italic"></span>  
  
  <span style="color:#aaa;font-style:italic">//2. add epoll
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">for</span>(nfds_t i=<span style="color:#099">0</span>;i&lt;nfds;i++)
  {
    arg.pPollItems[i].pSelf = arg.fds + i;  <span style="color:#aaa;font-style:italic">//关联stPollItem_t与pollfd
</span><span style="color:#aaa;font-style:italic"></span>    arg.pPollItems[i].pPoll = &amp;arg; <span style="color:#aaa;font-style:italic">//指向所属stPoll_t
</span><span style="color:#aaa;font-style:italic"></span>
    arg.pPollItems[i].pfnPrepare = OnPollPreparePfn;  <span style="color:#aaa;font-style:italic">//设置预处理
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">struct</span> <span style="color:#0a0;text-decoration:underline">epoll_event</span> &amp;ev = arg.pPollItems[i].stEvent;

    <span style="color:#00a">if</span>( fds[i].fd &gt; -<span style="color:#099">1</span> )  <span style="color:#aaa;font-style:italic">//fd有效
</span><span style="color:#aaa;font-style:italic"></span>    {
      ev.data.ptr = arg.pPollItems + i; <span style="color:#aaa;font-style:italic">//设置stPollItem_t.stEvent.data.ptr指向stPollItem_t
</span><span style="color:#aaa;font-style:italic"></span>      ev.events = PollEvent2Epoll( fds[i].events ); <span style="color:#aaa;font-style:italic">//设置stPollItem_t.stEvent.data.events
</span><span style="color:#aaa;font-style:italic"></span>
      <span style="color:#0aa">int</span> ret = co_epoll_ctl( epfd,EPOLL_CTL_ADD, fds[i].fd, &amp;ev ); <span style="color:#aaa;font-style:italic">//将stPollItem_t.stEvent加入stCoEpoll_t.iEpollFd中
</span><span style="color:#aaa;font-style:italic"></span>      <span style="color:#00a">if</span> (ret &lt; <span style="color:#099">0</span> &amp;&amp; errno == EPERM &amp;&amp; nfds == <span style="color:#099">1</span> &amp;&amp; pollfunc != <span style="color:#0aa">NULL</span>) <span style="color:#aaa;font-style:italic">//nfds只有一个时，插入epoll失败, 释放掉临时的stPoll_t
</span><span style="color:#aaa;font-style:italic"></span>      {
        <span style="color:#00a">if</span>( arg.pPollItems != arr )
        {
          free( arg.pPollItems );
          arg.pPollItems = <span style="color:#0aa">NULL</span>;
        }
        free(arg.fds);
        free(&amp;arg);
        <span style="color:#00a">return</span> pollfunc(fds, nfds, timeout);  <span style="color:#aaa;font-style:italic">//执行原生poll
</span><span style="color:#aaa;font-style:italic"></span>      }
    }
    <span style="color:#aaa;font-style:italic">//if fail,the timeout would work
</span><span style="color:#aaa;font-style:italic"></span>  }

  <span style="color:#aaa;font-style:italic">//3.add timeout
</span><span style="color:#aaa;font-style:italic"></span>
  <span style="color:#0aa">unsigned</span> <span style="color:#0aa">long</span> <span style="color:#0aa">long</span> now = GetTickMS();
  arg.ullExpireTime = now + timeout;
  <span style="color:#0aa">int</span> ret = AddTimeout( ctx-&gt;pTimeout,&amp;arg,now ); <span style="color:#aaa;font-style:italic">//将stPoll_t加入stCoEpoll_t的时间轮
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">int</span> iRaiseCnt = <span style="color:#099">0</span>;
  <span style="color:#00a">if</span>( ret != <span style="color:#099">0</span> )
  {
    co_log_err(<span style="color:#a50">&#34;CO_ERR: AddTimeout ret %d now %lld timeout %d arg.ullExpireTime %lld&#34;</span>,
        ret,now,timeout,arg.ullExpireTime);
    errno = EINVAL;
    iRaiseCnt = -<span style="color:#099">1</span>;

  }
    <span style="color:#00a">else</span>
  {
    co_yield_env( co_get_curr_thread_env() ); <span style="color:#aaa;font-style:italic">//让出CPU, 等待epoll中的事件发生或超时
</span><span style="color:#aaa;font-style:italic"></span>    iRaiseCnt = arg.iRaiseCnt;  <span style="color:#aaa;font-style:italic">//再次回来, 回来前会执行OnPollPreparePfn, 已经将stPoll_t设置好iRaiseCnt, revents, 并从时间轮中删除 
</span><span style="color:#aaa;font-style:italic"></span>  }

    {
    <span style="color:#aaa;font-style:italic">//clear epoll status and memory
</span><span style="color:#aaa;font-style:italic"></span>    RemoveFromLink&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( &amp;arg );  <span style="color:#aaa;font-style:italic">//从时间轮中删除
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#00a">for</span>(nfds_t i = <span style="color:#099">0</span>;i &lt; nfds;i++)
    {
      <span style="color:#0aa">int</span> fd = fds[i].fd;
      <span style="color:#00a">if</span>( fd &gt; -<span style="color:#099">1</span> )
      {
        co_epoll_ctl( epfd,EPOLL_CTL_DEL,fd,&amp;arg.pPollItems[i].stEvent ); <span style="color:#aaa;font-style:italic">//从epoll中删除
</span><span style="color:#aaa;font-style:italic"></span>      }
      fds[i].revents = arg.fds[i].revents;  <span style="color:#aaa;font-style:italic">//返回已经触发的事件
</span><span style="color:#aaa;font-style:italic"></span>    }


    <span style="color:#00a">if</span>( arg.pPollItems != arr ) <span style="color:#aaa;font-style:italic">//释放stPoll_t
</span><span style="color:#aaa;font-style:italic"></span>    {
      free( arg.pPollItems );
      arg.pPollItems = <span style="color:#0aa">NULL</span>;
    }

    free(arg.fds);
    free(&amp;arg);
  }

  <span style="color:#00a">return</span> iRaiseCnt;
}
</code></pre></td></tr></table>
</div>
</div><p>代码中前半部分将fd封装为</p>
<h1 id="最后">最后</h1>
<p>至此，我们介绍libco源码中自动切换的部分代码。感谢你的阅读。如果你你有任何疑虑和感想，或发现本文有任何错误，请一定<a href="mailto:changliu0828@gmail.com">让我知道</a>。</p>
<h1 id="参考">参考</h1>
<ol>
<li><a href="https://blog.csdn.net/weixin_43705457/article/details/106863859">libco源码分析，csdn</a></li>
<li><a href="http://purecpp.org/purecpp/static/64a819e99584452aab70a7f9c307717f.pdf">libco分享，李方源</a></li>
</ol>

</main>

<div class="post-comment">
    
</div>

  <footer>
  <script src="//yihui.name/js/math-code.js"></script>
<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

<script async src="//yihui.name/js/center-img.js"></script>

  
  <hr/>
  © <a href="www.changliu.me">Chang Liu</a> 2020 | <a href="mailto:changliu0828@gmail.com">Contact</a>
  
  </footer>
  </body>
</html>

